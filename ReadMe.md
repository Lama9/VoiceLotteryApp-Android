# VoiceLotteryApp (语音智控抽奖)

VoiceLotteryApp 是一款集成了**语音控制**、**局域网远程控制**和**智能语音播报**功能的现代化 Android 转盘抽奖应用。专为年会、活动、聚会等场景打造，支持高度自定义的奖项配置、公平的库存管理以及无人值守的自动运行模式。

---

## 🔥 核心功能

### 1. 🎤 全语音交互 (离线识别)

* **完全离线**：无需联网，基于 Vosk 引擎实现毫秒级语音识别。
* **语音指令**：
  * “**开始** / **启动** / **抽奖**”：启动转盘。
  * “**停止** / **停** / **结束**”：停止转盘并播报结果。
* **智能互斥**：当系统正在播报音效时，会自动暂停语音识别，防止“自己触发自己”的误操作。

### 2. 🎵 沉浸式语音播报 (MP3)

* **暖场模式**：闲置状态下，系统会随机播放欢迎/暖场语音（每 20-30 秒）。
* **全程音效**：包含启动音效、旋转音效及中奖后的专属播报。
* **开关控制**：可在设置中一键开启或关闭所有语音播报。

### 3. 📱 局域网远程控制

内置轻量级 HTTP Server (NanoHTTPD)，允许同一局域网下的 PC、中控软件或脚本远程控制抽奖流程。

* **API 地址**：`http://<手机IP>:<端口>/api/status`
* **默认端口**：`18888` (可在设置中修改)
* **支持操作**：查询状态、触发开始、触发停止并获取结果。

### 4. ⚙️ 强大的奖项管理

* **公平抽奖**：基于权重的随机算法，支持总概率自动归一化。
* **小数概率**：支持输入 `0.5`、`0.01` 等精细概率，总概率不足 100% 自动填充“谢谢参与”。
* **库存控制**：
  * 每个奖项可设置独立库存（例如：一等奖 1 个，二等奖 5 个）。
  * 库存耗尽后，该奖项虽然还在转盘上，但**绝对不会被抽中**（自动降级为兜底奖项）。
* **自定义外观**：支持修改奖项名称、扇区颜色。

---

## 🛠️ 技术栈

* **语言**: Java (Android SDK)
* **语音识别**: [Vosk Android](https://github.com/alphacep/vosk-android) (离线模型)
* **HTTP服务器**: [NanoHTTPD](https://github.com/NanoHttpd/nanohttpd)
* **数据存储**: SharedPreferences (JSON 序列化)
* **UI/动画**: Custom View (Canvas) + ObjectAnimator

---

## 📖 使用说明

### 1. 安装与权限

首次运行应用时，请授予 **录音权限 (Microphone)** 以启用语音控制功能。

### 2. 奖项配置

点击主界面右上角的 **⚙️ 设置按钮** 进入后台：

* **添加奖项**：点击底部的“+”号。
* **修改概率**：直接输入数字（支持小数），右侧会实时显示总概率。
* **设置库存**：输入整数。输入 `-1` 代表无限库存。
* **语音开关**：控制是否播放背景音效和结果播报。
* **远程端口**：修改 HTTP 服务监听端口。

### 3. 概率与库存规则

* **权重算法**：程序根据设定的概率进行加权随机。
* **库存检查**：
    1. 先根据概率随机出一个“目标奖项”。
    2. 检查该奖项是否有库存。
    3. **有库存** -> 中奖，扣减库存。
    4. **无库存** -> 触发“兜底机制”，改为中一个无限库存的奖项（如“安慰奖”或“谢谢参与”）。
    5. **公平性**：显示在转盘上的扇区大小**仅仅是视觉效果**（目前设为等分），实际中奖率完全取决于您设置的数值。

### 4. 音频文件替换

如果您想替换播报语音，请替换 `app/src/main/res/raw` 下的文件：

* `idle_welcome_x.m4a`：暖场语音（随机播放）
* `sfx_spin_start.m4a`：开始音效
* `prize_rank_0.m4a`：列表第 1 个奖项的中奖语音
* `prize_rank_1.m4a`：列表第 2 个奖项的中奖语音
* ...以此类推

---

## 🔌 远程控制 API 文档

| 动作 | 方法 | URL | 参数 | 返回示例 |
| :--- | :--- | :--- | :--- | :--- |
| **查状态** | GET | `/api/status` | 无 | `{"status": "idle", "ip": "..."}` |
| **开始** | POST | `/api/start` | 无 | `{"success": true}` |
| **停止** | POST | `/api/stop` | 无 | `{"success": true, "prize": "一等奖"}` |

> **注意**：`/api/stop` 接口是同步的，会等待转盘减速停止并算出结果后才返回 JSON 数据（约 3 秒延迟）。

---

## 📝 编译构建

项目包含动态构建时间功能：

```gradle
task updateBuildTimestamp {
    // 自动在 build_generated.xml 中注入当前时间
}
```

每次点击 Run 或 Build，设置页底部的版本信息都会自动更新为当前编译时间。
